<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOR-SR - Sistema de OptimizaciÃ³n de Rutas de Servicio de Reciclaje</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f9; color: #333; }
    header { background: #2c3e50; color: white; padding: 10px; text-align: center; }
    #map { height: 70vh; width: 100%; }
    .container { display: flex; flex-wrap: wrap; padding: 20px; gap: 20px; }
    .panel { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .panel h2 { margin-top: 0; color: #2c3e50; }
    .stats { display: flex; justify-content: space-between; margin-top: 10px; }
    .stat { background: #ecf0f1; padding: 10px; border-radius: 8px; flex: 1; margin: 5px; text-align: center; }
    .stat i { font-size: 24px; margin-bottom: 5px; color: #27ae60; }
    .btn { display: inline-block; padding: 10px 15px; margin: 5px 0; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
    .btn i { margin-right: 5px; }
    .btn:hover { background: #219150; }
    .notification { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 10px 20px; border-radius: 5px; display: none; }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-recycle"></i> SOR-SR - Sistema de OptimizaciÃ³n de Rutas de Reciclaje</h1>
  </header>
  <div id="map"></div>
  <div class="container">
    <div class="panel">
      <h2><i class="fas fa-chart-line"></i> EstadÃ­sticas</h2>
      <div class="stats">
        <div class="stat">
          <i class="fas fa-users"></i>
          <div id="totalUsuarios">0</div>
          <div>Usuarios Cubiertos</div>
        </div>
        <div class="stat">
          <i class="fas fa-percentage"></i>
          <div id="porcentajeCobertura">0%</div>
          <div>Cobertura</div>
        </div>
      </div>
    </div>
    <div class="panel">
      <h2><i class="fas fa-cogs"></i> Control</h2>
      <button class="btn" onclick="startTracking()"><i class="fas fa-play"></i> Iniciar Seguimiento</button>
      <button class="btn" onclick="stopTracking()"><i class="fas fa-stop"></i> Detener Seguimiento</button>
      <button class="btn" onclick="downloadCoverageData()"><i class="fas fa-file-excel"></i> Exportar Datos</button>
      <button class="btn" onclick="generateReportPDF()"><i class="fas fa-file-pdf"></i> Generar Reporte PDF</button>
      <button class="btn" onclick="exportMapAsImage()"><i class="fas fa-image"></i> Descargar Mapa</button>
    </div>
    <div class="panel">
      <h2><i class="fas fa-route"></i> Recorridos</h2>
      <div class="section">
        <h3><i class="fas fa-file-import"></i> Importar Recorrido (CSV)</h3>
        <input type="file" id="archivoRuta" accept=".csv" />
        <button class="btn" onclick="calcularCoberturaDesdeCSV()">
          <i class="fas fa-chart-pie"></i> Calcular cobertura desde archivo
        </button>
        <div id="resultadoCobertura" style="margin-top:10px; font-weight:bold;"></div>
      </div>
    </div>
  </div>
  <div class="notification" id="notification"></div>

  <script>
    let map = L.map('map').setView([7.0653, -73.8547], 13); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let trackedPoints = [];
    let tracking = false;
    let watchId = null;

    function startTracking() {
      if (tracking) return showNotification('El seguimiento ya estÃ¡ activo', 'error');
      if (!navigator.geolocation) return showNotification('La geolocalizaciÃ³n no estÃ¡ soportada', 'error');
      tracking = true;
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const marker = L.circleMarker([latitude, longitude], { radius: 5, color: "#e74c3c" }).addTo(map);
        trackedPoints.push({ lat: latitude, lng: longitude });
        updateStats();
      }, err => {
        showNotification('Error al obtener la ubicaciÃ³n: ' + err.message, 'error');
      });
      showNotification('Seguimiento iniciado', 'success');
    }

    function stopTracking() {
      if (!tracking) return showNotification('El seguimiento no estÃ¡ activo', 'error');
      navigator.geolocation.clearWatch(watchId);
      tracking = false;
      showNotification('Seguimiento detenido', 'success');
    }

    function updateStats() {
      const total = trackedPoints.length;
      const cobertura = Math.min(100, Math.round((total / 70000) * 100));
      document.getElementById('totalUsuarios').textContent = total;
      document.getElementById('porcentajeCobertura').textContent = cobertura + "%";
    }

    function downloadCoverageData() {
      const ws = XLSX.utils.json_to_sheet(trackedPoints);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
      XLSX.writeFile(wb, "cobertura.xlsx");
      showNotification('Datos exportados a Excel', 'success');
    }

    function generateReportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Reporte de Cobertura - SOR-SR", 20, 20);
      doc.text("Usuarios cubiertos: " + trackedPoints.length, 20, 40);
      const cobertura = Math.min(100, Math.round((trackedPoints.length / 70000) * 100));
      doc.text("Cobertura: " + cobertura + "%", 20, 60);
      doc.save("reporte_cobertura.pdf");
      showNotification('Reporte PDF generado', 'success');
    }

    function exportMapAsImage() {
      html2canvas(document.getElementById('map')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'mapa.png';
        link.href = canvas.toDataURL();
        link.click();
      });
      showNotification('Mapa descargado como imagen', 'success');
    }

    function showNotification(message, type) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
      notif.style.display = 'block';
      setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }

    function calcularCoberturaDesdeCSV() {
      const input = document.getElementById('archivoRuta');
      const resultado = document.getElementById('resultadoCobertura');
      if (!input.files.length) return showNotification('Selecciona un archivo .csv', 'error');
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = e.target.result.split('\n');
        const puntos = [];
        for (let i = 1; i < data.length; i++) {
          const [lat, lng] = data[i].split(',').map(Number);
          if (!isNaN(lat) && !isNaN(lng)) {
            puntos.push({ lat, lng });
            L.circleMarker([lat, lng], { radius: 4, color: "#2ecc71" }).addTo(map);
            trackedPoints.push({ lat, lng });
          }
        }
        const cobertura = Math.min(100, Math.round((puntos.length / 70000) * 100));
        resultado.innerHTML = `âœ” <b>${puntos.length}</b> usuarios cargados<br>ðŸ“Š Cobertura: <b>${cobertura}%</b>`;
        updateStats();
        showNotification('Archivo procesado', 'success');
      };
      reader.readAsText(input.files[0]);
    }
  </script>
</body>
</html>
