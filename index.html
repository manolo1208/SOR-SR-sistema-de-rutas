<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SOR-SR - Sistema de Optimizaci√≥n de Rutas de Servicio de Reciclaje</title>
  
  <!-- Estilos y librer√≠as -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f9; color: #333; }
    header { background: #2c3e50; color: white; padding: 10px; text-align: center; }
    #map { height: 65vh; width: 100%; }
    .container { display: flex; flex-wrap: wrap; padding: 20px; gap: 20px; }
    .panel { flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .panel h2, .panel h3 { margin-top: 0; color: #2c3e50; }
    .stats { display: flex; justify-content: space-between; margin-top: 10px; }
    .stat { background: #ecf0f1; padding: 10px; border-radius: 8px; flex: 1; margin: 5px; text-align: center; }
    .stat i { font-size: 24px; margin-bottom: 5px; color: #27ae60; }
    .btn { display: inline-block; padding: 10px 15px; margin: 5px 0; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
    .btn i { margin-right: 5px; }
    .btn:hover { background: #219150; }
    .notification { position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 10px 20px; border-radius: 5px; display: none; }
    .form-group { margin-bottom: 10px; }
    .form-group label { font-weight: bold; display: block; margin-bottom: 5px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-recycle"></i> SOR-SR - Sistema de Optimizaci√≥n de Rutas de Reciclaje</h1>
  </header>

  <div id="map"></div>

  <div class="container">
    <!-- Panel Estad√≠sticas -->
    <div class="panel">
      <h2><i class="fas fa-chart-line"></i> Estad√≠sticas</h2>
      <div class="stats">
        <div class="stat">
          <i class="fas fa-users"></i>
          <div id="totalUsuarios">0</div>
          <div>Usuarios Cubiertos</div>
        </div>
        <div class="stat">
          <i class="fas fa-percentage"></i>
          <div id="porcentajeCobertura">0%</div>
          <div>Cobertura</div>
        </div>
      </div>
    </div>

    <!-- Panel Control -->
    <div class="panel">
      <h2><i class="fas fa-cogs"></i> Control</h2>
      <button class="btn" onclick="startTracking()"><i class="fas fa-play"></i> Iniciar Seguimiento</button>
      <button class="btn" onclick="stopTracking()"><i class="fas fa-stop"></i> Detener Seguimiento</button>
      <button class="btn" onclick="downloadCoverageData()"><i class="fas fa-file-excel"></i> Exportar Datos</button>
      <button class="btn" onclick="generateReportPDF()"><i class="fas fa-file-pdf"></i> Generar Reporte PDF</button>
      <button class="btn" onclick="exportMapAsImage()"><i class="fas fa-image"></i> Descargar Mapa</button>
    </div>

    <!-- Panel Recorridos -->
    <div class="panel">
      <h3><i class="fas fa-file-import"></i> Importar Recorrido (CSV)</h3>
      <input type="file" id="archivoRuta" accept=".csv"/>
      <button class="btn" style="background:#3498db; margin-top:10px;" onclick="calcularCoberturaDesdeCSV()">
        <i class="fas fa-check-circle"></i> Calcular cobertura desde archivo
      </button>
      <div id="resultadoCobertura" style="margin-top:10px; font-weight:bold;"></div>
    </div>

    <!-- Panel Planificaci√≥n de Rutas -->
    <div class="panel">
      <h3><i class="fas fa-map-marked-alt"></i> Planificaci√≥n de Rutas</h3>
      <div class="form-group">
        <label for="routeName">Nombre de la Ruta:</label>
        <input type="text" id="routeName" placeholder="Ej: Zona Norte - Ma√±ana">
      </div>
      <div class="form-group">
        <label for="assignedRecycler">Reciclador Asignado:</label>
        <select id="assignedRecycler"
          <option value="">Seleccionar reciclador</option>
                <option value="1">Blanca Camacho Alfonso</option>
                <option value="2">Hernando Alfonso Carrillo Murillo</option>
                <option value="3">Adriano Castro Vega</option>
                <option value="4">Noralba Arias Rivera</option>
                <option value="5">Leonor De Jes√∫s Orozco Suarez</option>
                <option value="6">Wilson Jos√© Ravelo D√≠az</option>
                <option value="7">Tal√≠a Gomez Fuentes</option>
                <option value="8">Jos√© Manuel D√≠az Agudelo</option>
                <option value="9">Abel Antonio Mu√±oz Mac√≠as</option>
                <option value="10">Atilano Meneses Polo</option>
                <option value="11">Teresa De Jesus Isaza</option>
                <option value="12">Guillermo Quintero Cortes</option>
                <option value="13">Buenaventura Quintero Cortes</option>
                <option value="14">Jorge Iv√°n Londo√±o G√≥mez</option>
                <option value="15">Omar Antonio Mej√≠a Franco</option>
                <option value="16">Teresa del Carmen D√≠az Meza</option>
                <option value="17">Bernardino Morales Flores</option>
                <option value="18">San√≠n Enrique D√≠az Meza</option>
                <option value="19">Dagoberto D√≠az Meza</option>
                <option value="20">Luz Dary Agudelo Rodriguez</option>
                <option value="21">Manuel Antonio Rodriguez Guardia</option>
                <option value="22">Maria Edith Echeverri Villa</option>
                <option value="23">Luz Herminia Aguilera Vargas</option>
                <option value="24">Campo Elias Rueda Ni√±o</option>
                <option value="25">Laniker De Jes√∫s Diaz Agudelo</option>
                <option value="26">Rodolfo Rico Barroso</option>
                <option value="27">Henry Diaz</option>
                <option value="28">Karina Alexandra Meneses Garcia</option>
                <option value="29">Madeleine Diaz Barraza</option>
                <option value="30">Maria Camila Soto Moreno</option>
                <option value="31">Alvaro Barragan</option>
                <option value="32">Mario Rafael Guerra</option>
        </select>
      </div>
      <div class="form-group">
        <label for="vehicleType">Tipo de Veh√≠culo:</label>
        <select id="vehicleType">
          <option value="cart">Carretilla</option>
          <option value="bicycle">Bicicleta</option>
          <option value="motorcycle">Motocicleta</option>
          <option value="truck">Cami√≥n</option>
        </select>
      </div>
      <div class="form-group">
        <label for="barriosRuta">Barrios de la Ruta:</label>
        <textarea id="barriosRuta" placeholder="Ej: El Centro, Primero de Mayo, La Paz" rows="2"></textarea>
      </div>
      <button class="btn" onclick="createRoute()" style="width:100%;">
        <i class="fas fa-route"></i> Crear Ruta
      </button>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    let map = L.map('map').setView([7.0653, -73.8547], 13); 
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let trackedPoints = [];
    let tracking = false;
    let watchId = null;
    let routes = [];

    // √çconos veh√≠culos
    function getVehicleIcon(tipo) {
      return { cart:'üõí', bicycle:'üö≤', motorcycle:'üèçÔ∏è', truck:'üöõ' }[tipo] || 'üöó';
    }

    // Crear ruta activa
    function createRoute() {
      const name = document.getElementById('routeName').value;
      const recycler = document.getElementById('assignedRecycler').value;
      const vehicle = document.getElementById('vehicleType').value;
      const barrios = document.getElementById('barriosRuta').value;

      if (!name || !recycler) return showNotification("Completa todos los campos", "error");

      const iconoVehiculo = L.divIcon({
        html: `<div style="font-size: 22px;">${getVehicleIcon(vehicle)}</div>`,
        className: '',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });

      const marker = L.marker([7.0653, -73.8547], { icon: iconoVehiculo }).addTo(map)
        .bindPopup(`<b>${name}</b><br>Reciclador: ${recycler}<br>Veh√≠culo: ${vehicle}<br>Barrios: ${barrios}`);

      routes.push({ id: Date.now(), name, recycler, vehicle, barrios, marker });
      showNotification("Ruta creada y activada en el mapa", "success");
    }

    // Notificaciones
    function showNotification(message, type) {
      const notif = document.getElementById('notification');
      notif.textContent = message;
      notif.style.background = type === 'error' ? '#e74c3c' : '#27ae60';
      notif.style.display = 'block';
      setTimeout(() => { notif.style.display = 'none'; }, 3000);
    }

    // Seguimiento real GPS
    function startTracking() {
      if (tracking) return showNotification('El seguimiento ya est√° activo', "error");
      if (!navigator.geolocation) return showNotification('La geolocalizaci√≥n no est√° soportada', "error");
      tracking = true;
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        trackedPoints.push({ lat: latitude, lng: longitude });
        L.circleMarker([latitude, longitude], { radius: 4, color: "#e74c3c" }).addTo(map);
        updateStats();
      });
      showNotification("Seguimiento iniciado", "success");
    }

    function stopTracking() {
      if (!tracking) return showNotification("El seguimiento no est√° activo", "error");
      navigator.geolocation.clearWatch(watchId);
      tracking = false;
      showNotification("Seguimiento detenido", "success");
    }

    function updateStats() {
      const total = trackedPoints.length;
      const cobertura = Math.min(100, Math.round((total / 70000) * 100));
      document.getElementById('totalUsuarios').textContent = total;
      document.getElementById('porcentajeCobertura').textContent = cobertura + "%";
    }

    function downloadCoverageData() {
      const ws = XLSX.utils.json_to_sheet(trackedPoints);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
      XLSX.writeFile(wb, "cobertura.xlsx");
    }

    function generateReportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Reporte de Cobertura - SOR-SR", 20, 20);
      doc.text("Usuarios cubiertos: " + trackedPoints.length, 20, 40);
      const cobertura = Math.min(100, Math.round((trackedPoints.length / 70000) * 100));
      doc.text("Cobertura: " + cobertura + "%", 20, 60);
      doc.save("reporte_cobertura.pdf");
    }

    function exportMapAsImage() {
      html2canvas(document.getElementById('map')).then(canvas => {
        const link = document.createElement('a');
        link.download = 'mapa.png';
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    function calcularCoberturaDesdeCSV() {
      const input = document.getElementById('archivoRuta');
      if (!input.files.length) return showNotification("Selecciona un archivo CSV", "error");
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = e.target.result.split('\n');
        const puntos = [];
        for (let i=1;i<data.length;i++) {
          const [lat,lng] = data[i].split(',').map(Number);
          if (!isNaN(lat) && !isNaN(lng)) {
            puntos.push({lat,lng});
            L.circleMarker([lat,lng], { radius:4, color:"#2ecc71" }).addTo(map);
            trackedPoints.push({lat,lng});
          }
        }
        const cobertura = Math.min(100, Math.round((puntos.length / 70000) * 100));
        document.getElementById('resultadoCobertura').innerHTML = 
          `‚úî <b>${puntos.length}</b> usuarios cargados<br>üìä Cobertura: <b>${cobertura}%</b>`;
        updateStats();
      };
      reader.readAsText(input.files[0]);
    }
  </script>
</body>
</html>



